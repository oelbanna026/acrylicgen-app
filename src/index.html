<!DOCTYPE html>
<html lang="ar" dir="rtl" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>Acrylic Designer Pro | Free Laser Cutting SVG & DXF Generator</title>
    
    <!-- Version -->
    <meta name="version" content="1.3.4">
    <meta name="description" content="Free online tool to generate laser cutting files (SVG/DXF) for acrylic sheets. Auto-nesting, cost calculation, and custom box designs. No signup required for basic use.">
    <meta name="google-site-verification" content="wMLbUJjF8B9U5vfqp49VkhpBxLd8gkc926tZrHYKn_M" />
    <link rel="canonical" href="https://acrylicgen-app.com/" />

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1e293b">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://acrylicgen-app.com/">
    <meta property="og:title" content="Acrylic Designer Pro | Laser Cutting File Generator">
    <meta property="og:description" content="Generate SVG/DXF files for laser cutting instantly. Features: Auto Nesting, Cost Calculator, Box Generator.">
    <meta property="og:image" content="https://acrylicgen-app.com/assets/og-image.jpg">

    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://acrylicgen-app.com/">
    <meta property="twitter:title" content="Acrylic Designer Pro | Laser Cutting File Generator">
    <meta property="twitter:description" content="Generate SVG/DXF files for laser cutting instantly. Features: Auto Nesting, Cost Calculator, Box Generator.">
    <meta property="twitter:image" content="https://acrylicgen-app.com/assets/og-image.jpg">

    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1855840981689804" crossorigin="anonymous"></script>
    
    <!-- Performance: Preconnect to external domains -->
    <link rel="preconnect" href="https://pagead2.googlesyndication.com">
    <link rel="preconnect" href="https://www.paypal.com">
    
    <!-- SEO: Meta Tags -->
    <meta name="robots" content="index, follow">
    <meta name="keywords" content="acrylic box generator, laser cut svg, dxf generator, nesting tool, acrylic design, laser cutting software, cnc nesting">
    <meta name="author" content="AcrylicGen Team">
    <meta property="og:title" content="Acrylic Designer Pro - Professional Laser Cutting & Nesting Tool">
    <meta property="og:description" content="Design, nest, and calculate costs for acrylic sheets. Export DXF/SVG for laser cutting instantly.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://acrylicgen-app.com">
    <meta property="og:image" content="https://acrylicgen-app.com/assets/og-image.jpg">
    <meta name="twitter:card" content="summary_large_image">

    <!-- Schema.org Markup (SoftwareApplication) -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "SoftwareApplication",
      "name": "Acrylic Designer Pro",
      "applicationCategory": "DesignApplication",
      "operatingSystem": "Web",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD"
      },
      "description": "A professional tool for designing and calculating acrylic sheet costs efficiently. Features include auto-nesting, DXF/SVG export, and cost estimation.",
      "featureList": "Laser Cut Design, Auto Nesting, Cost Calculation, DXF Export, SVG Export"
    }
    </script>

    <!-- Tailwind CSS (Consider compiling for prod, but CDN ok for now) -->
    <script>
        // Suppress Tailwind CDN warning
        (function() {
            const originalWarn = console.warn;
            console.warn = function(...args) {
                if (args[0] && typeof args[0] === 'string' && args[0].includes('cdn.tailwindcss.com')) return;
                originalWarn.apply(console, args);
            };
        })();
    </script>
    <script src="vendor/tailwindcss.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#64748b',
                    }
                }
            }
        }
    </script>
    
    <!-- Alpine.js (Defer is good) -->
    <!-- <script defer src="vendor/alpine.min.js"></script> -->
    
    <!-- Libraries (Defer to unblock render) -->
    <script defer src="vendor/jspdf.umd.min.js"></script>
    <script defer src="vendor/driver.js"></script>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/style.css">
    
    <!-- Analytics: Google Analytics 4 (Placeholder) -->
    <!-- <script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script> -->
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      // gtag('config', 'G-XXXXXXXXXX'); 
    </script>

    <!-- Ads: Lazy Loaded via monetization.js to improve LCP -->
    <!-- Removed direct script tag to prevent blocking -->

    <!-- PayPal SDK (Defer) -->
    <script defer src="https://www.paypal.com/sdk/js?client-id=ATp1IFI6cxnoSWuZ1HpWOoj9xwUk8Og8IWoazQ3g1UodjOfj9iW6L0mjcYxdak4_7LpXGAVjrMVWWrGz&currency=USD"></script>

    <!-- Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <!-- Driver.js CSS -->
    <link rel="stylesheet" href="vendor/driver.css">

    <!-- App Logic (Defer all) -->
    <script src="js/auth.js?v=30"></script>
    <script defer src="js/tour.js?v=30"></script>
    <script defer src="js/monetization.js?v=30"></script>
    <script defer src="js/diagnostics.js?v=30"></script>
    <!-- Utilities -->
    <script src="js/utils/calculator.js?v=1"></script>
    
    <!-- Main App -->
    <script src="js/app.js?v=30"></script>
    <!-- <script defer src="js/app.bundle.js?v=13"></script> -->
    
    <!-- Alpine.js (Must load after app.js) -->
    <script defer src="vendor/alpine.min.js"></script>
    <script>
        // Global Fallback for critical handlers to prevent Alpine errors
        window.onMouseUp = function(e) {};
        window.onWheel = function(e) {};
        
        // Kill Switch for stuck Service Workers
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(function(registrations) {
                for(let registration of registrations) {
                    // FORCE UNREGISTER to clear old cache
                    registration.unregister();
                }
            });
        }
    </script>
</head>
<body x-data="app()" x-init="init()" :class="theme" :dir="lang === 'ar' ? 'rtl' : 'ltr'">

    <!-- Ad Modal -->
    <div x-show="showAdModal" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/80 backdrop-blur-sm" x-cloak x-transition>
        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-full max-w-md p-6 relative text-center">
            
            <div class="mb-4">
                <div class="inline-block p-3 rounded-full bg-blue-100 dark:bg-blue-900 text-blue-600 dark:text-blue-300 mb-2">
                    <svg class="w-8 h-8 animate-spin" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </div>
                <h3 class="text-xl font-bold dark:text-white">Processing your file...</h3>
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Please wait while we prepare your download.</p>
            </div>

            <!-- Ad Container -->
            <div class="bg-gray-100 dark:bg-slate-700 rounded-lg p-4 mb-4 min-h-[250px] flex items-center justify-center">
                <!-- Google AdSense Placeholder -->
                <div class="text-gray-400 text-sm">
                    <p>Advertisement</p>
                    <p class="text-xs mt-1">(Support us to keep this tool free ‚ù§Ô∏è)</p>
                </div>
                <!-- Actual Ad Code will go here -->
                <!-- <ins class="adsbygoogle" ...></ins> -->
            </div>

            <div class="text-center">
                <p class="text-sm font-bold text-gray-600 dark:text-gray-300 mb-2">
                    Download starting in <span x-text="adTimer" class="text-blue-500 text-lg">5</span>s
                </p>
                <button @click="showAdModal = false" class="text-xs text-gray-400 hover:text-gray-600 underline">
                    Upgrade to Pro to remove ads
                </button>
            </div>
        </div>
    </div>

    <!-- Public Stats Modal -->
    <div x-show="showPublicStatsModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm" x-cloak x-transition @click="showPublicStatsModal = false">
        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-full max-w-2xl p-6 relative" @click.stop>
            <button @click="showPublicStatsModal = false" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">‚úï</button>
            
            <h2 class="text-2xl font-bold mb-6 flex items-center gap-2 text-gray-800 dark:text-white">
                <svg class="w-6 h-6 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                </svg>
                <span x-text="t('stats_dashboard')"></span>
            </h2>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <!-- Total Views -->
                <div class="p-4 bg-blue-50 dark:bg-slate-700 rounded-lg flex items-center justify-between">
                    <div>
                        <div class="text-sm text-gray-500 dark:text-gray-400 font-bold" x-text="t('total_views')"></div>
                        <div class="text-3xl font-bold text-blue-600 dark:text-blue-400 mt-1" x-text="publicStats.totalViews"></div>
                    </div>
                    <div class="p-3 bg-blue-100 dark:bg-blue-900/30 rounded-full text-blue-600 dark:text-blue-400">
                        <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                        </svg>
                    </div>
                </div>

                <!-- Active Visitors -->
                <div class="p-4 bg-green-50 dark:bg-slate-700 rounded-lg flex items-center justify-between">
                    <div>
                        <div class="text-sm text-gray-500 dark:text-gray-400 font-bold flex items-center gap-2">
                            <span x-text="t('active_visitors')"></span>
                            <span class="relative flex h-2 w-2">
                              <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                              <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
                            </span>
                        </div>
                        <div class="text-3xl font-bold text-green-600 dark:text-green-400 mt-1" x-text="publicStats.activeUsers"></div>
                    </div>
                    <div class="p-3 bg-green-100 dark:bg-green-900/30 rounded-full text-green-600 dark:text-green-400">
                        <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                        </svg>
                    </div>
                </div>

                <!-- Sales 24h -->
                <div class="p-4 bg-purple-50 dark:bg-slate-700 rounded-lg flex items-center justify-between">
                    <div>
                        <div class="text-sm text-gray-500 dark:text-gray-400 font-bold" x-text="t('sales_24h')"></div>
                        <div class="text-3xl font-bold text-purple-600 dark:text-purple-400 mt-1" x-text="publicStats.sales24h"></div>
                    </div>
                    <div class="p-3 bg-purple-100 dark:bg-purple-900/30 rounded-full text-purple-600 dark:text-purple-400">
                        <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
                        </svg>
                    </div>
                </div>

                <!-- Conversion Rate -->
                <div class="p-4 bg-orange-50 dark:bg-slate-700 rounded-lg flex items-center justify-between">
                    <div>
                        <div class="text-sm text-gray-500 dark:text-gray-400 font-bold" x-text="t('conversion_rate')"></div>
                        <div class="text-3xl font-bold text-orange-600 dark:text-orange-400 mt-1">
                            <span x-text="publicStats.conversionRate"></span>%
                        </div>
                    </div>
                    <div class="p-3 bg-orange-100 dark:bg-orange-900/30 rounded-full text-orange-600 dark:text-orange-400">
                        <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                        </svg>
                    </div>
                </div>

                <!-- Total Exports -->
                <div class="col-span-1 sm:col-span-2 p-4 bg-gray-50 dark:bg-slate-700 rounded-lg flex items-center justify-between">
                    <div>
                        <div class="text-sm text-gray-500 dark:text-gray-400 font-bold" x-text="t('total_exports')"></div>
                        <div class="text-3xl font-bold text-gray-600 dark:text-gray-400 mt-1" x-text="publicStats.totalExports"></div>
                    </div>
                    <div class="p-3 bg-gray-100 dark:bg-gray-900/30 rounded-full text-gray-600 dark:text-gray-400">
                        <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                        </svg>
                    </div>
                </div>
            </div>
            
            <div class="mt-6 text-center text-xs text-gray-400">
                <p>Data updates automatically in real-time</p>
            </div>
        </div>
    </div>



    <!-- Admin Dashboard Modal -->
    <div x-show="showAdminModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm" x-cloak x-transition>
        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto p-6 relative" @click.outside="showAdminModal = false">
            <button @click="showAdminModal = false" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">‚úï</button>
            
            <h2 class="text-2xl font-bold mb-6" x-text="t('admin_dashboard')"></h2>

            <!-- Stats Grid -->
            <template x-if="adminStats">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                    <div class="p-4 bg-blue-50 dark:bg-slate-700 rounded-lg">
                        <div class="text-sm text-gray-500 dark:text-gray-400" x-text="t('total_users')"></div>
                        <div class="text-2xl font-bold text-blue-600 dark:text-blue-400" x-text="adminStats.totalUsers"></div>
                    </div>
                    <div class="p-4 bg-green-50 dark:bg-slate-700 rounded-lg">
                        <div class="text-sm text-gray-500 dark:text-gray-400" x-text="t('total_exports')"></div>
                        <div class="text-2xl font-bold text-green-600 dark:text-green-400" x-text="adminStats.totalExports"></div>
                    </div>
                    <div class="p-4 bg-purple-50 dark:bg-slate-700 rounded-lg">
                        <div class="text-sm text-gray-500 dark:text-gray-400" x-text="t('total_revenue')"></div>
                        <div class="text-2xl font-bold text-purple-600 dark:text-purple-400" x-text="currencySymbol + adminStats.totalRevenue"></div>
                    </div>
                    <div class="p-4 bg-orange-50 dark:bg-slate-700 rounded-lg">
                        <div class="text-sm text-gray-500 dark:text-gray-400">Active Now</div>
                        <div class="text-2xl font-bold text-orange-600 dark:text-orange-400" x-text="adminStats.activeNow || 0"></div>
                    </div>
                </div>
            </template>

            <!-- Users List -->
            <h3 class="text-xl font-bold mb-4" x-text="t('users_list')"></h3>
            <div class="overflow-x-auto rounded-lg border dark:border-slate-700">
                <table class="w-full text-sm text-left rtl:text-right text-gray-500 dark:text-gray-400">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-slate-700 dark:text-gray-400">
                        <tr>
                            <th scope="col" class="px-6 py-3">User</th>
                            <th scope="col" class="px-6 py-3">Plan/Credits</th>
                            <th scope="col" class="px-6 py-3">Session</th>
                            <th scope="col" class="px-6 py-3">Location</th>
                            <th scope="col" class="px-6 py-3">Role</th>
                            <th scope="col" class="px-6 py-3">Joined</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="u in adminUsers" :key="u.id">
                            <tr class="bg-white border-b dark:bg-slate-800 dark:border-slate-700 hover:bg-gray-50 dark:hover:bg-slate-600">
                                <td class="px-6 py-4">
                                    <div class="font-bold text-gray-900 dark:text-white" x-text="u.name"></div>
                                    <div class="text-xs" x-text="u.email"></div>
                                </td>
                                <td class="px-6 py-4">
                                    <span :class="{
                                        'bg-green-100 text-green-800': u.plan === 'business',
                                        'bg-blue-100 text-blue-800': u.plan === 'pro',
                                        'bg-yellow-100 text-yellow-800': u.plan === 'starter',
                                        'bg-gray-100 text-gray-800': u.plan === 'free'
                                    }" class="text-xs font-medium px-2 py-0.5 rounded border border-gray-200" x-text="u.plan.toUpperCase()"></span>
                                    <div class="text-xs mt-1">Credits: <span x-text="u.credits === -1 ? '‚àû' : u.credits"></span></div>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="text-xs text-green-600 font-bold" x-show="u.session_duration">Active: <span x-text="u.session_duration"></span></div>
                                    <div class="text-xs text-gray-400" x-text="'Last: ' + new Date(u.last_login).toLocaleTimeString()"></div>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="flex items-center gap-1">
                                        <span x-text="u.location"></span>
                                    </div>
                                    <div class="text-xs text-gray-400" x-text="u.ip"></div>
                                </td>
                                <td class="px-6 py-4" x-text="u.role"></td>
                                <td class="px-6 py-4" x-text="new Date(u.created_at).toLocaleDateString()"></td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Loading Screen -->
    <div x-show="loading" class="loader-overlay" x-transition.opacity>
        <div class="spinner mb-4"></div>
        <h2 class="text-xl font-bold" x-text="t('loading')"></h2>
    </div>

    <!-- Auth Gate Removed -->

    <!-- Update Notification -->
    <div x-show="updateAvailable" class="fixed bottom-4 left-4 z-50 bg-blue-600 text-white p-4 rounded-lg shadow-xl flex items-center gap-4" x-cloak x-transition>
        <div>
            <p class="font-bold" x-text="t('update_available')"></p>
        </div>
        <button @click="refreshApp()" class="bg-white text-blue-600 px-3 py-1 rounded font-bold text-sm" x-text="t('update_now')"></button>
    </div>

    <!-- Main Layout: Header + Content -->
    <div class="flex flex-col h-screen" x-cloak>
        
        <!-- Header -->
        <header class="h-16 flex items-center justify-between px-6 border-b shrink-0" 
                style="background-color: var(--bg-panel); border-color: var(--border);">
            
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center text-white shadow-lg">
                    <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2"></rect>
                        <circle cx="8.5" cy="8.5" r="1.5"></circle>
                    </svg>
                </div>
                <h1 class="text-xl font-bold tracking-tight">
                    <span x-text="t('app_title')"></span>
                </h1>
            </div>

            <div class="flex items-center gap-3">
                <!-- Auth -->
                <template x-if="!user">
                    <div class="flex gap-2 mx-2">
                        <button @click="showLoginModal = true" class="px-3 py-1 text-sm font-bold text-blue-500 hover:bg-blue-50 dark:hover:bg-slate-800 rounded transition">Login</button>
                        <button @click="showRegisterModal = true" class="px-3 py-1 text-sm font-bold bg-blue-500 text-white hover:bg-blue-600 rounded transition">Register</button>
                    </div>
                </template>
                <template x-if="user">
                    <div class="flex items-center gap-2 mx-2 cursor-pointer" @click="showDashboardModal = true; loadHistory()">
                        <div class="text-right hidden sm:block">
                            <div class="text-xs font-bold text-blue-500">
                                <span x-text="user.credits === -1 ? '‚àû' : user.credits"></span> Credits
                            </div>
                        </div>
                        <div class="w-8 h-8 rounded-full bg-blue-500 text-white flex items-center justify-center font-bold shadow-sm">
                            <span x-text="user.name ? user.name.charAt(0).toUpperCase() : 'U'"></span>
                        </div>
                    </div>
                </template>

                <select id="currency-select" name="currency" aria-label="Currency" x-model="currency" class="px-2 py-1 rounded border text-sm font-bold transition"
                        style="background-color: var(--input-bg); border-color: var(--border); color: var(--text-main);">
                    <template x-for="c in currencies">
                        <option :value="c.code" x-text="c.code"></option>
                    </template>
                </select>

                <a href="pricing.html" class="px-3 py-1 text-sm font-bold text-blue-500 hover:bg-blue-50 dark:hover:bg-slate-800 rounded transition border border-blue-500">Pricing</a>

                <button @click.stop="showPublicStatsModal = true" class="p-2 rounded-full hover:bg-opacity-10 hover:bg-gray-500 transition text-blue-500" :title="t('view_stats')">
                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                    </svg>
                </button>

                <button @click="toggleTheme()" class="p-2 rounded-full hover:bg-opacity-10 hover:bg-gray-500 transition" :title="t('toggle_theme')">
                    <span x-show="theme === 'dark'">‚òÄÔ∏è</span>
                    <span x-show="theme === 'light'">üåô</span>
                </button>

                <button @click="toggleLang()" class="px-3 py-1 rounded border font-bold text-sm transition hover:bg-opacity-10 hover:bg-gray-500"
                        style="border-color: var(--border);">
                    <span x-text="lang === 'ar' ? 'EN' : 'ÿπÿ±ÿ®Ÿä'"></span>
                </button>

                <button id="btn-restart-tour" @click="restartTour()" class="w-8 h-8 rounded-full border flex items-center justify-center hover:bg-gray-100 dark:hover:bg-slate-700 transition font-bold" :title="t('restart_tour')" style="border-color: var(--border);">
                    ?
                </button>
            </div>
        </header>

        <!-- Body: Sidebar + Canvas -->
        <div class="flex-1 flex overflow-hidden relative">
            
            <!-- Mobile Overlay -->
            <div x-show="showSidebar" @click="showSidebar = false" x-transition.opacity 
                 class="fixed inset-0 bg-black/50 z-20 md:hidden" x-cloak></div>

            <!-- Sidebar -->
            <aside id="sidebar-panel" class="w-80 flex flex-col border-e overflow-y-auto transition-transform duration-300 z-30 shadow-xl absolute md:static top-0 h-full shrink-0"
                   :class="{
                       'translate-x-0': showSidebar,
                       '-translate-x-full': !showSidebar && lang !== 'ar', 
                       'translate-x-full': !showSidebar && lang === 'ar',
                       'md:transform-none': true,
                       'border-r': lang !== 'ar', 
                       'border-l': lang === 'ar',
                       'left-0': lang !== 'ar',
                       'right-0': lang === 'ar'
                   }"
                   style="background-color: var(--bg-panel); border-color: var(--border);">
                
                <!-- Tools Toolbar -->
                <div id="toolbar-section" class="p-2 grid grid-cols-4 gap-1 border-b" style="border-color: var(--border)">
                    <button @click="rotateSelectedShape()" :title="t('rotate')" class="p-2 rounded hover:bg-gray-100 dark:hover:bg-slate-700 text-blue-500">
                        <svg class="w-5 h-5 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                    </button>
                    <button @click="duplicateSelectedShape()" :title="t('duplicate')" class="p-2 rounded hover:bg-gray-100 dark:hover:bg-slate-700 text-green-500">
                        <svg class="w-5 h-5 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                        </svg>
                    </button>
                    <button @click="snapEnabled = !snapEnabled" :title="t('snap_to_grid')" class="p-2 rounded hover:bg-gray-100 dark:hover:bg-slate-700" :class="snapEnabled ? 'text-purple-500 bg-purple-50 dark:bg-purple-900/20' : 'text-gray-400'">
                         <svg class="w-5 h-5 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                        </svg>
                    </button>
                    <button id="btn-nesting" @click="showNestingPanel = !showNestingPanel" :title="t('nesting')" class="p-2 rounded hover:bg-gray-100 dark:hover:bg-slate-700" :class="showNestingPanel ? 'text-orange-500 bg-orange-50 dark:bg-orange-900/20' : 'text-gray-400'">
                         <svg class="w-5 h-5 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
                        </svg>
                    </button>
                </div>

                <!-- Nesting Panel -->
                <div x-show="showNestingPanel" x-collapse x-cloak class="bg-orange-50 dark:bg-slate-800/50 p-4 border-b border-orange-100 dark:border-slate-700">
                    <h3 class="text-xs font-bold uppercase mb-2 text-orange-600" x-text="t('nesting_settings')"></h3>
                    <div class="flex gap-2 mb-2">
                        <div>
                            <label for="nesting-width" class="text-[10px] text-gray-500" x-text="t('canvas_w')"></label>
                            <input id="nesting-width" name="nestingWidth" type="number" x-model.number="nestingSheetWidth" class="w-full p-1 text-xs rounded border bg-white dark:bg-slate-700 dark:text-white dark:border-slate-600 text-gray-900">
                        </div>
                        <div>
                            <label for="nesting-height" class="text-[10px] text-gray-500" x-text="t('canvas_h')"></label>
                            <input id="nesting-height" name="nestingHeight" type="number" x-model.number="nestingSheetHeight" class="w-full p-1 text-xs rounded border bg-white dark:bg-slate-700 dark:text-white dark:border-slate-600 text-gray-900">
                        </div>
            </div>
            
            <div class="mb-2">
                <label for="nesting-margin" class="text-[10px] text-gray-500" x-text="t('nesting_margin')"></label>
                <div class="relative">
                     <input id="nesting-margin" name="nestingMargin" type="number" step="0.1" min="0" x-model.number="nestingMargin" class="w-full p-1 text-xs rounded border bg-white dark:bg-slate-700 dark:text-white dark:border-slate-600 text-gray-900">
                     <span class="absolute end-2 top-1 text-[10px] text-gray-400 pointer-events-none" x-text="unit"></span>
                </div>
            </div>

            <button @click="nestShapes()" class="w-full py-1 bg-orange-500 text-white text-xs font-bold rounded hover:bg-orange-600 transition" x-text="t('nest_now')"></button>
                    
                    <hr class="my-2 border-orange-200 dark:border-slate-600">
                    
                    <h3 class="text-xs font-bold uppercase mb-2 text-orange-600" x-text="t('fill_sheet')"></h3>
                    <div class="mb-2">
                        <label for="fill-count" class="text-[10px] text-gray-500" x-text="t('fill_count')"></label>
                        <input id="fill-count" name="fillCount" type="number" x-model.number="fillCount" placeholder="Auto" class="w-full p-1 text-xs rounded border bg-white dark:bg-slate-700 dark:text-white dark:border-slate-600 text-gray-900">
                    </div>
                    <button @click="fillSheet()" class="w-full py-1 bg-blue-500 text-white text-xs font-bold rounded hover:bg-blue-600 transition" x-text="t('fill_btn')"></button>
                </div>

                <!-- Ad Slot (Top Sidebar) -->
                <div class="p-2">
                    <div class="ad-slot">
                        <!-- Google AdSense Placeholder -->
                        <span class="text-xs text-gray-400">Google Ad (Responsive)</span>
                    </div>
                    
                    <!-- System Stats -->
                    <div class="mt-2 bg-blue-50 dark:bg-slate-700/50 rounded p-2 text-center" x-show="publicStats.totalUsers > 0">
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <div>
                                <div class="font-bold text-blue-600 dark:text-blue-400" x-text="publicStats.activeUsers"></div>
                                <div class="text-[10px] text-gray-500">Active Now</div>
                            </div>
                            <div>
                                <div class="font-bold text-green-600 dark:text-green-400" x-text="publicStats.totalExports"></div>
                                <div class="text-[10px] text-gray-500">Exports</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="p-5 space-y-6">
                    
                    <!-- Section: Layers / Shapes -->
                    <div id="layers-section">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-sm font-bold uppercase tracking-wider" style="color: var(--text-muted)" x-text="t('layers')"></h3>
                            <div class="flex gap-2">
                                <button @click="clearAllShapes()" class="text-xs bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600 transition" x-show="shapes.length > 0" x-text="t('delete_all')">Clear</button>
                                <button @click="addShape()" class="text-xs bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600 transition" x-text="t('add_shape')">+</button>
                            </div>
                        </div>
                        <div class="space-y-2 max-h-40 overflow-y-auto custom-scrollbar">
                            <template x-for="(s, index) in shapes" :key="s.id">
                                <div class="flex items-center justify-between p-2 rounded cursor-pointer border transition"
                                     :class="activeShapeId === s.id ? 'bg-blue-50 border-blue-200 dark:bg-blue-900/30 dark:border-blue-700' : 'bg-gray-50 border-transparent hover:bg-gray-100 dark:bg-slate-700 dark:hover:bg-slate-600'"
                                     @click="selectShape(s.id)">
                                    <div class="flex items-center gap-2">
                                        <span class="text-xs font-bold w-4 h-4 flex items-center justify-center rounded-full bg-gray-200 dark:bg-slate-600" x-text="index + 1"></span>
                                        <span class="text-sm font-medium" x-text="(s.name || 'Shape ' + (index + 1)) + ' (' + s.width + 'x' + s.height + ')'"></span>
                                    </div>
                                    <button @click.stop="removeShape(s.id)" class="text-red-400 hover:text-red-600 px-1" title="Delete">√ó</button>
                                </div>
                            </template>
                        </div>
                        <hr class="mt-4" style="border-color: var(--border)">
                    </div>

                    <!-- Section: Dimensions -->
                    <div id="dimensions-section">
                        <h3 class="text-sm font-bold uppercase mb-3 tracking-wider" style="color: var(--text-muted)" x-text="t('dimensions')"></h3>
                        
                        <div class="mb-4">
                            <label class="block text-xs mb-1" x-text="t('unit')"></label>
                            <div class="flex bg-gray-100 dark:bg-slate-800 rounded p-1 gap-1">
                                <template x-for="u in ['mm', 'cm', 'inch']">
                                    <button @click="unit = u" 
                                            class="flex-1 py-1 text-sm rounded transition"
                                            :class="unit === u ? 'bg-blue-500 text-white shadow' : 'text-gray-500 hover:text-gray-700 dark:text-gray-400'"
                                            x-text="u"></button>
                                </template>
                            </div>
                        </div>

                        <!-- Position -->
                        <div class="grid grid-cols-2 gap-3 mb-3">
                            <div>
                                <label for="pos-x" class="block text-xs mb-1 text-gray-700 dark:text-gray-300" x-text="t('x_pos')"></label>
                                <div class="relative">
                                    <input id="pos-x" name="posX" type="number" step="0.5" x-model.number="x" class="form-input w-full p-2 rounded text-sm">
                                    <span class="absolute end-2 top-2.5 text-xs text-gray-500 pointer-events-none" x-text="unit"></span>
                                </div>
                            </div>
                            <div>
                                <label for="pos-y" class="block text-xs mb-1 text-gray-700 dark:text-gray-300" x-text="t('y_pos')"></label>
                                <div class="relative">
                                    <input id="pos-y" name="posY" type="number" step="0.5" x-model.number="y" class="form-input w-full p-2 rounded text-sm">
                                    <span class="absolute end-2 top-2.5 text-xs text-gray-500 pointer-events-none" x-text="unit"></span>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label for="shape-width" class="block text-xs mb-1 text-gray-700 dark:text-gray-300" x-text="t('width')"></label>
                                <div class="relative">
                                    <input id="shape-width" name="shapeWidth" type="number" :min="limits.min" :max="limits.max" :step="limits.step" x-model.number="width" class="form-input w-full p-2 rounded text-sm">
                                    <span class="absolute end-2 top-2.5 text-xs text-gray-500 pointer-events-none" x-text="unit"></span>
                                </div>
                            </div>
                            <div>
                                <label for="shape-height" class="block text-xs mb-1 text-gray-700 dark:text-gray-300" x-text="t('height')"></label>
                                <div class="relative">
                                    <input id="shape-height" name="shapeHeight" type="number" :min="limits.min" :max="limits.max" :step="limits.step" x-model.number="height" class="form-input w-full p-2 rounded text-sm">
                                    <span class="absolute end-2 top-2.5 text-xs text-gray-500 pointer-events-none" x-text="unit"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Shape Selection -->
                        <div class="mt-4">
                            <label for="shape-type" class="block text-xs mb-1 text-gray-700 dark:text-gray-300" x-text="t('shape')"></label>
                            <select id="shape-type" name="shapeType" x-model="shapeType" class="form-input w-full p-2 rounded text-sm">
                                <option value="rectangle" x-text="t('shape_rect')"></option>
                                <option value="banner" x-text="t('shape_banner')"></option>
                                <option value="arch" x-text="t('shape_arch')"></option>
                                <option value="circle" x-text="t('shape_circle')"></option>
                                <option value="oval" x-text="t('shape_oval')"></option>
                                <option value="pentagon" x-text="t('shape_pentagon') + ' (Pro)'"></option>
                                <option value="hexagon" x-text="t('shape_hexagon') + ' (Pro)'"></option>
                                <option value="star" x-text="t('shape_star') + ' (Pro)'"></option>
                            </select>
                        </div>
                    </div>

                    <hr style="border-color: var(--border)">

                    <!-- Section: Corners (Rectangle) / Curve Depth (Shield) -->
                    <div x-show="['rectangle', 'banner'].includes(shapeType)" x-transition>
                        <h3 class="text-sm font-bold uppercase mb-3 tracking-wider" style="color: var(--text-muted)" 
                            x-text="shapeType === 'rectangle' ? t('corners') : (lang === 'ar' ? 'ÿπŸÖŸÇ ÿßŸÑÿ™ŸÇŸàŸäÿ≥' : 'Curve Depth')"></h3>
                        
                        <!-- Rectangle Corner Type -->
                        <div class="mb-3" x-show="shapeType === 'rectangle'">
                            <label for="corner-type" class="sr-only">Corner Type</label>
                            <select id="corner-type" name="cornerType" x-model="cornerType" class="form-input w-full p-2 rounded text-sm">
                                <option value="straight" x-text="t('straight')"></option>
                                <option value="rounded" x-text="t('rounded')"></option>
                            </select>
                        </div>

                        <!-- Radius / Depth Slider -->
                        <div x-show="shapeType === 'banner' || (shapeType === 'rectangle' && cornerType === 'rounded')" x-transition class="mt-2">
                            <div class="flex justify-between mb-1">
                                <label for="corner-radius" class="text-xs text-gray-700 dark:text-gray-300" 
                                       x-text="shapeType === 'rectangle' ? t('radius') : (lang === 'ar' ? 'ÿßŸÑÿπŸÖŸÇ' : 'Depth')"></label>
                                <span class="text-xs font-mono" x-text="cornerRadius + ' ' + unit"></span>
                            </div>
                            <input id="corner-radius" name="cornerRadius" type="range" 
                                   :min="0" :max="Math.min(width, height)/2" :step="limits.step" 
                                   x-model.number="cornerRadius" 
                                   class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-500">
                            
                            <!-- Rectangle Corner Selection -->
                            <div class="grid grid-cols-2 gap-2 mt-3" x-show="shapeType === 'rectangle' && activeShape.cornerSides">
                                <label class="flex items-center gap-2 text-xs cursor-pointer">
                                    <input type="checkbox" x-model="activeShape.cornerSides.tl" class="rounded text-blue-500 accent-blue-500">
                                    <span x-text="lang === 'ar' ? 'ÿ£ÿπŸÑŸâ Ÿäÿ≥ÿßÿ±' : 'Top Left'"></span>
                                </label>
                                <label class="flex items-center gap-2 text-xs cursor-pointer">
                                    <input type="checkbox" x-model="activeShape.cornerSides.tr" class="rounded text-blue-500 accent-blue-500">
                                    <span x-text="lang === 'ar' ? 'ÿ£ÿπŸÑŸâ ŸäŸÖŸäŸÜ' : 'Top Right'"></span>
                                </label>
                                <label class="flex items-center gap-2 text-xs cursor-pointer">
                                    <input type="checkbox" x-model="activeShape.cornerSides.bl" class="rounded text-blue-500 accent-blue-500">
                                    <span x-text="lang === 'ar' ? 'ÿ£ÿ≥ŸÅŸÑ Ÿäÿ≥ÿßÿ±' : 'Bottom Left'"></span>
                                </label>
                                <label class="flex items-center gap-2 text-xs cursor-pointer">
                                    <input type="checkbox" x-model="activeShape.cornerSides.br" class="rounded text-blue-500 accent-blue-500">
                                    <span x-text="lang === 'ar' ? 'ÿ£ÿ≥ŸÅŸÑ ŸäŸÖŸäŸÜ' : 'Bottom Right'"></span>
                                </label>
                            </div>
                        </div>
                        <hr class="mt-4" style="border-color: var(--border)">
                    </div>

                    <hr style="border-color: var(--border)">

                    <!-- Section: Holes -->
                    <div>
                        <h3 class="text-sm font-bold uppercase mb-3 tracking-wider" style="color: var(--text-muted)" x-text="t('holes')"></h3>
                        <div class="mb-3">
                            <label for="hole-pattern" class="sr-only">Hole Pattern</label>
                            <select id="hole-pattern" name="holePattern" x-model="holePattern" class="form-input w-full p-2 rounded text-sm">
                                <option value="none" x-text="t('no_holes')"></option>
                                <option value="corners" x-text="t('corners_4')"></option>
                                <option value="corners_mid" x-text="t('side_6')"></option>
                                <option value="side_2" x-text="t('side_2')"></option>
                                <option value="custom" x-text="t('custom_count')"></option>
                            </select>
                        </div>
                        
                        <div x-show="holePattern === 'custom'" class="mb-3" x-transition>
                             <div class="flex justify-between mb-1">
                                <label for="hole-count" class="text-xs text-gray-700 dark:text-gray-300" x-text="t('hole_count')"></label>
                                <span class="text-xs font-mono" x-text="holeCount"></span>
                             </div>
                             <input id="hole-count" name="holeCount" type="range" min="1" max="100" step="1" x-model.number="holeCount" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-500">
                        </div>

                        <div x-show="holePattern !== 'none'" x-transition class="grid grid-cols-1 gap-4">
                            <div>
                                <div class="flex justify-between mb-1">
                                    <label for="hole-diameter" class="text-xs text-gray-700 dark:text-gray-300" x-text="t('diameter')"></label>
                                    <span class="text-xs font-mono" x-text="holeDiameter + ' ' + unit"></span>
                                </div>
                                <input id="hole-diameter" name="holeDiameter" type="range" :min="limits.holeMin" :max="limits.holeMax" :step="limits.holeStep" x-model.number="holeDiameter" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-500">
                            </div>
                            <div>
                                <div class="flex justify-between mb-1">
                                    <label for="hole-margin" class="text-xs text-gray-700 dark:text-gray-300" x-text="t('margin')"></label>
                                    <span class="text-xs font-mono" x-text="holeMargin + ' ' + unit"></span>
                                </div>
                                <input id="hole-margin" name="holeMargin" type="range" :min="0" :max="Math.min(width, height)/3" :step="limits.step" x-model.number="holeMargin" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-500">
                            </div>
                        </div>
                    </div>

                    <hr style="border-color: var(--border)">

                    <!-- Section: Base Generator -->
                    <div id="base-section">
                        <div class="flex items-center gap-2 mb-3">
                            <h3 class="text-sm font-bold uppercase tracking-wider" style="color: var(--text-muted)" x-text="t('base_generator')"></h3>
                            <!-- Pro Badge -->
                            <span x-show="user && user.plan === 'free' && !Monetization.hasFeature('advanced_shapes')" 
                                  class="bg-yellow-100 text-yellow-800 text-[10px] px-1.5 py-0.5 rounded border border-yellow-200 font-bold flex items-center gap-1">
                                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"/></svg>
                                PRO
                            </span>
                        </div>
                        
                        <div class="mb-3">
                            <label class="flex items-center gap-2 text-sm font-bold cursor-pointer" :class="{'opacity-75': user && user.plan === 'free' && !Monetization.hasFeature('advanced_shapes')}">
                                <input type="checkbox" x-model="activeShape.hasBase" class="rounded text-blue-500 accent-blue-500 w-4 h-4">
                                <span x-text="t('enable_base')"></span>
                            </label>
                        </div>

                        <div x-show="activeShape.hasBase" x-transition class="space-y-3">
                            <!-- Thickness Selection -->
                            <div>
                                <label class="block text-xs mb-1 text-gray-700 dark:text-gray-300" x-text="t('base_thickness')"></label>
                                <div class="flex gap-2 mb-2">
                                    <template x-for="th in [3, 5, 8]">
                                        <button @click="activeShape.baseThickness = th; if(activeShape.linkedBaseId) generateBase(true)"
                                                class="flex-1 py-1 text-xs rounded border transition"
                                                :class="activeShape.baseThickness === th ? 'bg-blue-500 text-white border-blue-600' : 'bg-white dark:bg-slate-700 text-gray-700 dark:text-gray-300 border-gray-300 dark:border-slate-600 hover:bg-gray-50'"
                                                x-text="th + ' mm'"></button>
                                    </template>
                                </div>
                                <div class="relative">
                                     <input type="number" step="0.1" x-model.number="activeShape.baseThickness" @input="if(activeShape.linkedBaseId) generateBase(true)" class="form-input w-full p-2 rounded text-sm" placeholder="Custom Thickness">
                                     <span class="absolute end-2 top-2.5 text-xs text-gray-500 pointer-events-none">mm</span>
                                </div>
                            </div>

                            <!-- Base Dimensions -->
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs mb-1 text-gray-700 dark:text-gray-300" x-text="t('base_width')"></label>
                                    <div class="relative">
                                        <input type="number" x-model.number="activeShape.baseWidth" @input="if(activeShape.linkedBaseId) generateBase(true)" class="form-input w-full p-2 rounded text-sm">
                                        <span class="absolute end-2 top-2.5 text-xs text-gray-500 pointer-events-none" x-text="unit"></span>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-xs mb-1 text-gray-700 dark:text-gray-300" x-text="t('base_depth')"></label>
                                    <div class="relative">
                                        <input type="number" x-model.number="activeShape.baseDepth" @input="if(activeShape.linkedBaseId) generateBase(true)" class="form-input w-full p-2 rounded text-sm">
                                        <span class="absolute end-2 top-2.5 text-xs text-gray-500 pointer-events-none" x-text="unit"></span>
                                    </div>
                                </div>
                            </div>

                            <!-- Tab Width (New) -->
                            <div>
                                <label class="block text-xs mb-1 text-gray-700 dark:text-gray-300" x-text="lang === 'ar' ? 'ÿπÿ±ÿ∂ ÿßŸÑŸÜÿ™Ÿàÿ° (ÿßÿ™ÿ±ŸÉŸá ŸÅÿßÿ±ÿ∫ÿßŸã ŸÑŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä)' : 'Tab Width (Auto if empty)'"></label>
                                <div class="relative">
                                    <input type="number" x-model.number="activeShape.baseTabWidth" @input="if(activeShape.linkedBaseId) generateBase(true)" class="form-input w-full p-2 rounded text-sm" placeholder="Auto">
                                    <span class="absolute end-2 top-2.5 text-xs text-gray-500 pointer-events-none">mm</span>
                                </div>
                            </div>

                            <!-- Base Radius -->
                            <div>
                                <div class="flex justify-between mb-1">
                                    <label class="text-xs text-gray-700 dark:text-gray-300" x-text="t('base_radius')"></label>
                                    <span class="text-xs font-mono" x-text="activeShape.baseRadius + ' ' + unit"></span>
                                </div>
                                <input type="range" :min="0" :max="Math.min(activeShape.baseWidth || 0, activeShape.baseDepth || 0)/2" :step="limits.step" x-model.number="activeShape.baseRadius" @input="if(activeShape.linkedBaseId) generateBase(true)" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-500">
                            </div>

                            <!-- Actions -->
                            <div class="mt-2">
                                <button @click="generateBase()" class="w-full py-2 rounded bg-green-600 hover:bg-green-700 text-white text-xs font-bold transition shadow-sm">
                                    <span x-text="t('generate_base_btn')"></span>
                                </button>
                            </div>
                        </div>
                    </div>

                </div>

                    <hr style="border-color: var(--border)">
                    
                    <!-- Section: Cost Settings -->
                    <div id="cost-section" class="p-5 pt-0">
                        <button @click="showCostSettings = !showCostSettings" class="flex items-center justify-between w-full text-left py-2">
                            <h3 class="text-sm font-bold uppercase tracking-wider" style="color: var(--text-muted)" x-text="t('pricing_settings')"></h3>
                            <span class="text-xs transition-transform duration-200" :class="{'rotate-180': showCostSettings}">‚ñº</span>
                        </button>
                        
                        <div x-show="showCostSettings" x-collapse x-cloak class="space-y-3 pt-2">
                            <div>
                                <div class="flex justify-between items-center mb-1">
                                    <label for="cost-sheet-width" class="block text-xs text-gray-700 dark:text-gray-300" x-text="t('sheet_dims')"></label>
                                    <select x-model="sheetUnit" class="text-[10px] p-0.5 border rounded bg-white dark:bg-slate-700 dark:text-white">
                                        <option value="cm">cm</option>
                                        <option value="mm">mm</option>
                                        <option value="inch">inch</option>
                                    </select>
                                </div>
                                <div class="flex gap-2 relative">
                                    <input id="cost-sheet-width" name="sheetWidth" aria-label="Sheet Width" type="number" x-model.number="sheetWidth" class="form-input w-full p-2 rounded text-sm" placeholder="W">
                                    <input id="cost-sheet-height" name="sheetHeight" aria-label="Sheet Height" type="number" x-model.number="sheetHeight" class="form-input w-full p-2 rounded text-sm" placeholder="H">
                                    <span class="absolute end-2 top-2.5 text-xs text-gray-500 pointer-events-none" x-text="sheetUnit"></span>
                                </div>
                            </div>
                            <div>
                                <label for="cost-sheet-price" class="block text-xs mb-1 text-gray-700 dark:text-gray-300" x-text="t('sheet_price')"></label>
                                <input id="cost-sheet-price" name="sheetPrice" type="number" min="0" x-model.number="sheetPrice" class="form-input w-full p-2 rounded text-sm">
                            </div>
                            
                            <!-- Area Info -->
                            <div class="bg-gray-100 dark:bg-slate-700 p-2 rounded text-xs space-y-1">
                                <div class="flex justify-between">
                                    <span x-text="t('width') + ':'"></span>
                                    <span class="font-bold" x-text="designDimensions.width.toFixed(2) + ' ' + unit"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span x-text="t('height') + ':'"></span>
                                    <span class="font-bold" x-text="designDimensions.height.toFixed(2) + ' ' + unit"></span>
                                </div>
                                <div class="flex justify-between border-t border-gray-300 dark:border-gray-600 pt-1 mt-1">
                                    <span x-text="t('area')"></span>
                                    <span class="font-bold" x-text="totalAreaCm2.toFixed(2) + ' cm¬≤'"></span>
                                </div>
                                <div class="flex justify-between items-center text-xs text-gray-600 dark:text-gray-400 mt-1">
                                    <span x-text="t('cutting_time')"></span>
                                    <span class="font-bold" x-text="totalCuttingTimeMinutes.toFixed(1) + ' min'"></span>
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-2">
                                <div class="col-span-2">
                                    <label for="cost-thickness" class="block text-[10px] mb-1 text-gray-700 dark:text-gray-300" x-text="t('thickness_mm')"></label>
                                    <input id="cost-thickness" name="thickness" type="number" min="0" step="0.1" x-model.number="thickness" class="form-input w-full p-1.5 rounded text-sm">
                                </div>
                                <div>
                                    <label for="cost-cutting" class="block text-[10px] mb-1 text-gray-700 dark:text-gray-300" x-text="t('cutting_price_hr')"></label>
                                    <input id="cost-cutting" name="cuttingPrice" type="number" min="0" x-model.number="cuttingPricePerHour" class="form-input w-full p-1.5 rounded text-sm">
                                </div>
                                <div>
                                    <label class="block text-[10px] mb-1 text-gray-700 dark:text-gray-300" x-text="t('cutting_speed') || 'Speed (cm/min)'"></label>
                                    <input type="number" min="1" x-model.number="cuttingSpeed" class="form-input w-full p-1.5 rounded text-sm">
                                </div>
                                <div>
                                    <label class="block text-[10px] mb-1 text-gray-700 dark:text-gray-300" x-text="t('quantity')"></label>
                                    <input type="number" min="1" x-model.number="quantity" class="form-input w-full p-1.5 rounded text-sm">
                                </div>
                                <div>
                                    <label class="block text-[10px] mb-1 text-gray-700 dark:text-gray-300" x-text="t('waste_percent')"></label>
                                    <input type="number" min="0" x-model.number="wastePercent" class="form-input w-full p-1.5 rounded text-sm">
                                </div>
                                <div>
                                    <label class="block text-[10px] mb-1 text-gray-700 dark:text-gray-300" x-text="t('overhead_percent')"></label>
                                    <input type="number" min="0" x-model.number="overheadPercent" class="form-input w-full p-1.5 rounded text-sm">
                                </div>
                                <div>
                                    <label for="cost-profit" class="block text-[10px] mb-1 text-gray-700 dark:text-gray-300" x-text="t('profit_margin')"></label>
                                    <input id="cost-profit" name="profitMargin" type="number" min="0" x-model.number="profitMargin" class="form-input w-full p-1.5 rounded text-sm">
                                </div>
                                <div>
                                    <label class="block text-[10px] mb-1 text-gray-700 dark:text-gray-300" x-text="t('setup_fee')"></label>
                                    <input type="number" min="0" x-model.number="setupFee" class="form-input w-full p-1.5 rounded text-sm">
                                </div>
                                <div>
                                    <label class="block text-[10px] mb-1 text-gray-700 dark:text-gray-300" x-text="t('min_charge')"></label>
                                    <input type="number" min="0" x-model.number="minCharge" class="form-input w-full p-1.5 rounded text-sm">
                                </div>
                            </div>
                        </div>
                    </div>

                <!-- Footer Stats & Export -->
                <div id="export-section" class="mt-auto p-5 border-t" style="border-color: var(--border); background-color: rgba(0,0,0,0.02);">
                    <div class="mb-3">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-xs text-gray-500" x-text="t('dimensions')"></span>
                            <span class="font-mono text-sm font-bold dir-ltr" x-text="dimensionsFormatted"></span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-xs text-gray-500" x-text="t('area')"></span>
                            <span class="font-bold text-blue-500 text-sm dir-ltr" x-text="areaTotalFormatted"></span>
                        </div>
                        <div class="flex justify-between items-center mt-1">
                            <span class="text-xs text-gray-500" x-text="t('cutting_time')"></span>
                            <span class="font-bold text-orange-500 text-sm dir-ltr" x-text="totalCuttingTimeMinutes.toFixed(1) + ' min'"></span>
                        </div>
                    </div>

                    <!-- Detailed Cost Breakdown -->
                    <div class="space-y-1 mb-4 border-t pt-2 border-dashed text-xs" x-show="costReport">
                        <div class="flex justify-between">
                            <span class="text-gray-500" x-text="t('material_cost')"></span>
                            <span x-text="(currencySymbol || '$') + costReport.results.materialCost.toFixed(2)"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-500" x-text="t('operation_cost')"></span>
                            <span x-text="(currencySymbol || '$') + costReport.results.operationCost.toFixed(2)"></span>
                        </div>
                        <div class="flex justify-between" x-show="costReport.results.wasteCost > 0">
                            <span class="text-gray-500" x-text="t('waste_cost')"></span>
                            <span x-text="(currencySymbol || '$') + costReport.results.wasteCost.toFixed(2)"></span>
                        </div>
                         <div class="flex justify-between" x-show="costReport.results.overheadCost > 0">
                            <span class="text-gray-500" x-text="t('overhead_cost')"></span>
                            <span x-text="(currencySymbol || '$') + costReport.results.overheadCost.toFixed(2)"></span>
                        </div>
                        <div class="flex justify-between font-bold mt-2 pt-2 border-t border-gray-100 dark:border-gray-700">
                            <span x-text="t('unit_price')"></span>
                            <span class="text-blue-600" x-text="(currencySymbol || '$') + costReport.results.unitPrice.toFixed(2)"></span>
                        </div>
                        <div class="flex justify-between items-center bg-green-50 dark:bg-green-900/20 p-2 rounded mt-1">
                            <div>
                                <span class="font-bold text-sm"><span x-text="t('total_price')"></span> <span x-show="quantity > 1" x-text="'(' + quantity + ')'"></span>:</span>
                                <!-- Min Charge Badge -->
                                <div x-show="costReport.results.isMinChargeApplied" class="text-[10px] text-red-500 font-semibold" x-text="'(Min Charge Applied)'"></div>
                            </div>
                            <span class="text-xl font-extrabold text-green-600 dark:text-green-400" x-text="(currencySymbol || '$') + costReport.results.totalBatchPrice.toFixed(2)"></span>
                        </div>
                        <div class="flex justify-between items-center mt-2 gap-2">
                             <button @click="copyPrice()" class="flex-1 bg-slate-200 dark:bg-slate-700 py-1 rounded hover:bg-slate-300 transition text-[10px]" x-text="t('copy')"></button>
                             <button @click="resetCostSettings()" class="flex-1 bg-slate-200 dark:bg-slate-700 py-1 rounded hover:bg-slate-300 transition text-[10px]" x-text="t('reset')"></button>
                             <button @click="exportCostPDF()" class="flex-1 bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-300 py-1 rounded hover:bg-red-200 transition text-[10px]" x-text="t('export_pdf')"></button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-2 mb-4">
                        <button @click="exportDXF()" class="py-2 rounded bg-slate-600 hover:bg-slate-700 text-white text-sm font-bold transition flex items-center justify-center gap-1">
                            <span x-text="t('export_dxf')"></span>
                            <!-- Lock Icon for Free users -->
                            <svg x-show="user && user.plan === 'free' && !Monetization.checkLimit()" class="w-3 h-3 text-yellow-400" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a5 5 0 00-5 5v2a2 2 0 00-2 2v5a2 2 0 002 2h10a2 2 0 002-2v-5a2 2 0 00-2-2H7V7a3 3 0 015.905-.75 1 1 0 001.937-.5A5.002 5.002 0 0010 2z"/></svg>
                        </button>
                        <button @click="exportSVG()" class="py-2 rounded bg-red-600 hover:bg-red-700 text-white text-sm font-bold transition">SVG</button>
                    </div>

                    <!-- Legal Links -->
                    <div class="text-center text-[10px] text-gray-400 flex justify-center gap-3">
                        <a href="privacy.html" target="_blank" class="hover:underline">Privacy</a>
                        <span>‚Ä¢</span>
                        <a href="terms.html" target="_blank" class="hover:underline">Terms</a>
                        <span>‚Ä¢</span>
                        <a href="/designs" class="hover:underline text-blue-500">Popular Designs</a>
                        <span>‚Ä¢</span>
                        <button @click="showAboutModal = true" class="hover:underline">About</button>
                    </div>
                </div>
            </aside>

            <!-- Main Canvas -->
            <main id="canvas-area" class="flex-1 relative overflow-hidden canvas-area cursor-grab active:cursor-grabbing"
                  :class="{'cursor-move': isDraggingShape}"
                  x-ref="canvas"
                  @wheel.prevent="onWheel"
                  @mousedown="onStartPan"
                  @mousemove="onMouseMove"
                  @mouseup="onMouseUp"
                  @mouseleave="onMouseUp"
                  @touchstart.prevent="onStartTouch"
                  @touchmove.prevent="onMoveTouch"
                  @touchend="onEndTouch">
                
                <!-- SVG Canvas -->
                <svg x-ref="svg" 
                     class="w-full h-full block touch-none"
                     xmlns="http://www.w3.org/2000/svg">
                    
                    <!-- Grid Background -->
                    <defs>
                        <pattern id="grid" width="50" height="50" patternUnits="userSpaceOnUse">
                            <path d="M 50 0 L 0 0 0 50" fill="none" stroke="currentColor" stroke-width="0.5" class="text-gray-200 dark:text-slate-800"/>
                        </pattern>
                    </defs>
                    <rect width="100%" height="100%" fill="url(#grid)" />

                    <!-- Sheet Boundaries (Visual Guide) -->
                    <rect :x="parseFloat(pan.x) || 0" :y="parseFloat(pan.y) || 0" 
                          :width="(parseFloat(nestingSheetWidth) || 0) * (parseFloat(zoom) || 1)" 
                          :height="(parseFloat(nestingSheetHeight) || 0) * (parseFloat(zoom) || 1)" 
                          fill="none" stroke="red" stroke-width="1" stroke-dasharray="5,5" opacity="0.5" pointer-events="none" />

                    <!-- Camera Group -->
                    <g :transform="`translate(${parseFloat(pan.x) || 0}, ${parseFloat(pan.y) || 0}) scale(${parseFloat(zoom) || 1})`">
                        <!-- Origin Marker -->
                        <path d="M -10 0 L 10 0 M 0 -10 L 0 10" stroke="gray" stroke-width="1" opacity="0.5" />
                    </g>
                </svg>

                <!-- Shapes Layer (Separate SVG to avoid template issues) -->
                <div class="absolute inset-0 pointer-events-none">
                    <template x-for="shape in shapes" :key="shape.id">
                        <svg class="absolute inset-0 w-full h-full overflow-visible pointer-events-none" xmlns="http://www.w3.org/2000/svg">
                            <g :transform="`translate(${parseFloat(pan.x) || 0}, ${parseFloat(pan.y) || 0}) scale(${parseFloat(zoom) || 1})`">
                                <g :transform="`translate(${parseFloat(shape.x)||0}, ${parseFloat(shape.y)||0}) rotate(${parseFloat(shape.rotation)||0}, ${(parseFloat(shape.width)||0)/2}, ${(parseFloat(shape.height)||0)/2})`"
                                   :data-id="shape.id"
                                   class="cursor-pointer transition-opacity pointer-events-auto"
                                   :class="activeShapeId === shape.id ? 'opacity-100' : 'opacity-80 hover:opacity-100'"
                                   @mousedown.stop="startShapeDrag($event, shape.id)"
                                   @touchstart.stop="startShapeDrag($event, shape.id)">
                                    
                                    <!-- Shape Body -->
                                    <path :d="getShapePath(shape)" 
                                          :fill="activeShapeId === shape.id ? '#ffffff' : '#f0f0f0'" 
                                          fill-opacity="0.9" 
                                          :stroke="activeShapeId === shape.id ? '#3b82f6' : '#000000'" 
                                          :stroke-width="activeShapeId === shape.id ? 2 : 1.5" 
                                          vector-effect="non-scaling-stroke" 
                                          class="drop-shadow-sm transition-all duration-300"/>
                                    
                                    <!-- Holes -->
                                    <path :d="getHolesPath(shape)" 
                                          fill="none" 
                                          stroke="#ef4444" 
                                          stroke-width="1.5" 
                                          vector-effect="non-scaling-stroke" />
                        
                                    <!-- Labels (Active Only) -->
                                    <g x-show="activeShapeId === shape.id" pointer-events="none">
                                         <!-- Top Label (Width) -->
                                         <rect :x="(parseFloat(shape.width)||0)/2 - 15*labelScale" 
                                               :y="-8*labelScale" 
                                               :width="30*labelScale" 
                                               :height="6*labelScale" 
                                               :rx="2*labelScale" 
                                               fill="var(--bg-panel)" 
                                               fill-opacity="0.8" />
                                         <text :x="(parseFloat(shape.width)||0)/2" 
                                               :y="-4*labelScale" 
                                               text-anchor="middle" 
                                               font-weight="bold" 
                                               fill="var(--text-main)" 
                                               :style="`font-size: ${3*labelScale}px`"
                                               x-text="shape.width + ' ' + unit"></text>
                                         
                                         <!-- Left Label (Height) -->
                                         <rect :x="-8*labelScale" 
                                               :y="(parseFloat(shape.height)||0)/2 - 15*labelScale" 
                                               :width="6*labelScale" 
                                               :height="30*labelScale" 
                                               :rx="2*labelScale" 
                                               fill="var(--bg-panel)" 
                                               fill-opacity="0.8" />
                                         <text :x="-5*labelScale" 
                                               :y="(parseFloat(shape.height)||0)/2" 
                                               text-anchor="middle" 
                                               font-weight="bold" 
                                               fill="var(--text-main)" 
                                               :transform="`rotate(-90, ${-5*labelScale}, ${(parseFloat(shape.height)||0)/2})`"
                                               :style="`font-size: ${3*labelScale}px`"
                                               x-text="shape.height + ' ' + unit"></text>
                                    </g>
                                </g>
                            </g>
                        </svg>
                    </template>

                    <!-- Base Preview (Real-time) -->
                    <template x-if="activeShape && activeShape.hasBase && !activeShape.linkedBaseId">
                        <svg class="absolute inset-0 w-full h-full overflow-visible pointer-events-none" xmlns="http://www.w3.org/2000/svg">
                            <g :transform="`translate(${parseFloat(pan.x) || 0}, ${parseFloat(pan.y) || 0}) scale(${parseFloat(zoom) || 1})`">
                                <g :transform="`translate(${parseFloat(activeShape.x) + 50}, ${parseFloat(activeShape.y) + parseFloat(activeShape.height) + 20})`"
                                   class="transition-all duration-300">
                                    
                                    <!-- Base Body (Solid) -->
                                    <rect :width="parseFloat(activeShape.baseWidth) || 80" 
                                          :height="parseFloat(activeShape.baseDepth) || 30" 
                                          :rx="parseFloat(activeShape.baseRadius) || 5"
                                          fill="#ffffff" 
                                          fill-opacity="0.9"
                                          stroke="#3b82f6" 
                                          stroke-width="2" />
                                    
                                    <!-- Slot/Hole Preview -->
                                    <rect :x="((parseFloat(activeShape.baseWidth) || 80) - getTabWidth(activeShape)) / 2"
                                          :y="((parseFloat(activeShape.baseDepth) || 30) - mmToUnit(parseFloat(thickness) || 3)) / 2"
                                          :width="getTabWidth(activeShape)"
                                          :height="mmToUnit(parseFloat(thickness) || 3)"
                                          fill="none"
                                          stroke="#ef4444"
                                          stroke-width="1" />

                                    <!-- Label -->
                                    <text :x="(parseFloat(activeShape.baseWidth) || 80)/2" 
                                          y="-8" 
                                          text-anchor="middle" 
                                          font-size="10" 
                                          fill="#3b82f6" 
                                          font-weight="bold"
                                          class="bg-white px-1"
                                          style="text-shadow: 0 0 2px white;"
                                          x-text="lang === 'ar' ? 'ŸÖÿπÿßŸäŸÜÿ© (ÿßÿ∂ÿ∫ÿ∑ ÿ•ŸÜÿ¥ÿßÿ°)' : 'Preview (Click Create)'"></text>
                                </g>
                            </g>
                        </svg>
                    </template>
                </div>

                <!-- Zoom Controls Overlay -->
                <div class="absolute bottom-5 right-5 flex flex-col gap-2 bg-white dark:bg-slate-800 p-2 rounded-lg shadow-xl border border-gray-200 dark:border-slate-700"
                     :class="lang === 'ar' ? 'left-5 right-auto' : 'right-5 left-auto'">
                    <button @click="zoomIn()" class="w-8 h-8 flex items-center justify-center rounded hover:bg-gray-100 dark:hover:bg-slate-700 text-xl font-bold">+</button>
                    <button @click="resetView()" class="w-8 h-8 flex items-center justify-center rounded hover:bg-gray-100 dark:hover:bg-slate-700 font-bold text-sm">‚ü≤</button>
                    <button @click="zoomOut()" class="w-8 h-8 flex items-center justify-center rounded hover:bg-gray-100 dark:hover:bg-slate-700 text-xl font-bold">-</button>
                </div>
                
                <!-- Debug / Status Overlay -->
                <div x-show="holes.length === 0 && holePattern !== 'none'" 
                     class="absolute top-5 left-1/2 transform -translate-x-1/2 bg-red-500 text-white px-4 py-2 rounded shadow-lg text-sm font-bold animate-pulse pointer-events-none">
                     <span x-text="t('warning_no_holes')"></span>
                </div>

            </main>
        </div>
    </div>
    <!-- Login Modal -->
    <div x-show="showLoginModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm" x-cloak x-transition>
        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-full max-w-md p-6 relative" @click.outside="showLoginModal = false">
            <button @click="showLoginModal = false" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">‚úï</button>
            <h2 class="text-2xl font-bold mb-6 text-center">Login</h2>
            <form @submit.prevent="login">
                <div class="mb-4">
                    <label for="login-email" class="block text-sm font-bold mb-2">Email</label>
                    <input id="login-email" name="email" type="email" autocomplete="username" x-model="authLogin.email" class="w-full p-3 rounded border dark:bg-slate-700 dark:border-slate-600" required>
                </div>
                <div class="mb-6">
                    <label for="login-password" class="block text-sm font-bold mb-2">Password</label>
                    <input id="login-password" name="password" type="password" autocomplete="current-password" x-model="authLogin.password" class="w-full p-3 rounded border dark:bg-slate-700 dark:border-slate-600" required>
                </div>
                <button type="submit" class="w-full py-3 bg-blue-600 text-white rounded font-bold hover:bg-blue-700 transition">Login</button>
            </form>

            <div class="mt-4 mb-4">
                <div class="relative flex py-2 items-center">
                    <div class="flex-grow border-t border-gray-300 dark:border-gray-600"></div>
                    <span class="flex-shrink-0 mx-4 text-gray-400 text-xs">OR</span>
                    <div class="flex-grow border-t border-gray-300 dark:border-gray-600"></div>
                </div>
                <div id="g_id_onload"
                     data-client_id="848633901532-m8q0ors3lj860dbj2l0ie1gknvepi2h1.apps.googleusercontent.com"
                     data-context="signin"
                     data-ux_mode="popup"
                     data-callback="handleGoogleCredentialResponse"
                     data-auto_prompt="false">
                </div>
                <div class="g_id_signin"
                     data-type="standard"
                     data-shape="rectangular"
                     data-theme="outline"
                     data-text="sign_in_with"
                     data-size="large"
                     data-logo_alignment="left"
                     data-width="100%">
                </div>
            </div>

            <p class="mt-4 text-center text-sm text-gray-500">
                <a href="#" @click.prevent="showLoginModal = false; showForgotPasswordModal = true" class="text-gray-500 hover:text-gray-700 block mb-2" x-text="t('forgot_password')"></a>
                Don't have an account? <a href="#" @click.prevent="showLoginModal = false; showRegisterModal = true" class="text-blue-500 font-bold">Register</a>
            </p>
        </div>
    </div>

    <!-- Forgot Password Modal -->
    <div x-show="showForgotPasswordModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm" x-cloak x-transition>
        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-full max-w-md p-6 relative" @click.outside="showForgotPasswordModal = false">
            <button @click="showForgotPasswordModal = false" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">‚úï</button>
            <h2 class="text-2xl font-bold mb-6 text-center" x-text="t('forgot_password')"></h2>
            <form @submit.prevent="forgotPassword">
                <div class="mb-6">
                    <label for="forgot-email" class="block text-sm font-bold mb-2">Email</label>
                    <input id="forgot-email" name="email" type="email" autocomplete="email" x-model="forgotPasswordEmail" class="w-full p-3 rounded border dark:bg-slate-700 dark:border-slate-600" required>
                </div>
                <button type="submit" class="w-full py-3 bg-blue-600 text-white rounded font-bold hover:bg-blue-700 transition" x-text="t('send_reset_link')"></button>
            </form>
            <p class="mt-4 text-center text-sm text-gray-500">
                <a href="#" @click.prevent="showForgotPasswordModal = false; showLoginModal = true" class="text-blue-500 font-bold" x-text="t('login')"></a>
            </p>
        </div>
    </div>

    <!-- Register Modal -->
    <div x-show="showRegisterModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm" x-cloak x-transition>
        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-full max-w-md p-6 relative" @click.outside="showRegisterModal = false">
            <button @click="showRegisterModal = false" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">‚úï</button>
            <h2 class="text-2xl font-bold mb-6 text-center">Register</h2>
            <form @submit.prevent="register">
                <div class="mb-4">
                    <label for="register-name" class="block text-sm font-bold mb-2">Name</label>
                    <input id="register-name" name="name" type="text" autocomplete="name" x-model="authRegister.name" class="w-full p-3 rounded border dark:bg-slate-700 dark:border-slate-600" required>
                </div>
                <div class="mb-4">
                    <label for="register-email" class="block text-sm font-bold mb-2">Email</label>
                    <input id="register-email" name="email" type="email" autocomplete="username" x-model="authRegister.email" class="w-full p-3 rounded border dark:bg-slate-700 dark:border-slate-600" required>
                </div>
                <div class="mb-6">
                    <label for="register-password" class="block text-sm font-bold mb-2">Password</label>
                    <input id="register-password" name="password" type="password" autocomplete="new-password" x-model="authRegister.password" class="w-full p-3 rounded border dark:bg-slate-700 dark:border-slate-600" required>
                </div>
                <button type="submit" class="w-full py-3 bg-blue-600 text-white rounded font-bold hover:bg-blue-700 transition">Create Account</button>
            </form>

            <div class="mt-4 mb-4">
                <div class="relative flex py-2 items-center">
                    <div class="flex-grow border-t border-gray-300 dark:border-gray-600"></div>
                    <span class="flex-shrink-0 mx-4 text-gray-400 text-xs">OR</span>
                    <div class="flex-grow border-t border-gray-300 dark:border-gray-600"></div>
                </div>
                <!-- Google Button (Reused) -->
                <div class="g_id_signin"
                     data-type="standard"
                     data-shape="rectangular"
                     data-theme="outline"
                     data-text="signup_with"
                     data-size="large"
                     data-logo_alignment="left"
                     data-width="100%">
                </div>
            </div>

            <p class="mt-4 text-center text-sm text-gray-500">
                Already have an account? <a href="#" @click.prevent="showRegisterModal = false; showLoginModal = true" class="text-blue-500 font-bold">Login</a>
            </p>
        </div>
    </div>

    <!-- Dashboard Modal -->
    <div x-show="showDashboardModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm" x-cloak x-transition>
        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-full max-w-2xl p-6 relative max-h-[90vh] overflow-y-auto" @click.outside="showDashboardModal = false">
            <button @click="showDashboardModal = false" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">‚úï</button>
            
            <div class="flex items-center gap-4 mb-8">
                <div class="w-16 h-16 rounded-full bg-blue-500 text-white flex items-center justify-center text-2xl font-bold">
                    <span x-text="user?.name?.charAt(0).toUpperCase()"></span>
                </div>
                <div>
                    <h2 class="text-2xl font-bold" x-text="user?.name"></h2>
                    <p class="text-gray-500" x-text="user?.email"></p>
                </div>
                <div class="ml-auto text-right">
                    <div class="text-sm text-gray-500">Current Plan</div>
                    <div class="text-xl font-bold text-blue-500 uppercase" x-text="user?.plan"></div>
                </div>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-8">
                <div class="p-4 bg-gray-50 dark:bg-slate-700 rounded-lg text-center">
                    <div class="text-3xl font-bold text-blue-500 mb-1" x-text="user?.credits === -1 ? '‚àû' : user?.credits"></div>
                    <div class="text-xs font-bold uppercase text-gray-500">Available Credits</div>
                </div>
                <div class="p-4 bg-gray-50 dark:bg-slate-700 rounded-lg text-center cursor-pointer hover:bg-gray-100 dark:hover:bg-slate-600 transition" @click="showDashboardModal = false; showPricingModal = true">
                    <div class="text-3xl font-bold text-green-500 mb-1">Top Up</div>
                    <div class="text-xs font-bold uppercase text-gray-500">Buy Credits / Upgrade</div>
                </div>
                <template x-if="user?.role === 'admin'">
                    <div class="p-4 bg-purple-50 dark:bg-slate-700 rounded-lg text-center cursor-pointer hover:bg-purple-100 dark:hover:bg-purple-900/20 transition" @click="showDashboardModal = false; openAdminDashboard()">
                        <div class="text-3xl font-bold text-purple-500 mb-1">‚öôÔ∏è</div>
                        <div class="text-xs font-bold uppercase text-gray-500" x-text="t('admin_dashboard')"></div>
                    </div>
                </template>
                <div class="p-4 bg-gray-50 dark:bg-slate-700 rounded-lg text-center cursor-pointer hover:bg-red-50 dark:hover:bg-red-900/20 transition" @click="logout">
                    <div class="text-3xl font-bold text-red-500 mb-1">‚èª</div>
                    <div class="text-xs font-bold uppercase text-gray-500">Logout</div>
                </div>
            </div>

            <div class="mb-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-lg" x-text="t('history')"></h3>
                    <button @click="loadHistory()" class="text-sm text-blue-500 hover:underline">Refresh</button>
                </div>
                
                <template x-if="history.length === 0">
                    <div class="text-center text-gray-400 py-8" x-text="t('no_history')"></div>
                </template>
                
                <div class="overflow-x-auto max-h-60 overflow-y-auto">
                    <table class="w-full text-sm text-left" x-show="history.length > 0">
                        <thead class="text-xs uppercase bg-gray-50 dark:bg-slate-700 text-gray-700 dark:text-gray-400 sticky top-0">
                            <tr>
                                <th class="px-4 py-2" x-text="t('date')"></th>
                                <th class="px-4 py-2" x-text="t('type')"></th>
                                <th class="px-4 py-2" x-text="t('cost_credits')"></th>
                                <th class="px-4 py-2">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="item in history" :key="item.id">
                                <tr class="border-b dark:border-slate-700 hover:bg-gray-50 dark:hover:bg-slate-700">
                                    <td class="px-4 py-2" x-text="new Date(item.created_at).toLocaleDateString()"></td>
                                    <td class="px-4 py-2" x-text="item.type.toUpperCase()"></td>
                                    <td class="px-4 py-2" x-text="item.cost"></td>
                                    <td class="px-4 py-2">
                                        <button @click="loadDesign(item.parameters)" class="text-blue-500 hover:underline text-xs font-bold" x-text="t('re_export')"></button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Pricing Modal -->
    <div x-show="showPricingModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm" x-cloak x-transition>
        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-full max-w-4xl p-6 relative max-h-[90vh] overflow-y-auto" @click.outside="showPricingModal = false">
            <button @click="showPricingModal = false" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">‚úï</button>
            
            <h2 class="text-3xl font-bold text-center mb-2" x-text="t('upgrade_plan')"></h2>
            <p class="text-center text-gray-500 mb-4" x-text="lang === 'ar' ? 'ÿßÿÆÿ™ÿ± ÿßŸÑÿÆÿ∑ÿ© ÿßŸÑŸÖŸÜÿßÿ≥ÿ®ÿ© ŸÑÿßÿ≠ÿ™Ÿäÿßÿ¨ÿßÿ™ŸÉ' : 'Choose the best plan for your needs'"></p>

            <!-- Currency Selector -->
            <div class="flex justify-center mb-4">
                <select x-model="currency" @change="setCurrency($event.target.value)" class="p-1 rounded border text-sm bg-gray-50 dark:bg-slate-700">
                    <template x-for="c in currencies">
                        <option :value="c.code" x-text="c.code + ' - ' + c.name" :selected="currency === c.code"></option>
                    </template>
                </select>
            </div>

            <!-- Toggle -->
            <div class="flex justify-center items-center gap-4 mb-8">
                <span class="text-sm font-semibold" :class="!isAnnual ? 'text-slate-900 dark:text-white' : 'text-slate-500'" x-text="t('billing_monthly')"></span>
                <button 
                    @click="isAnnual = !isAnnual"
                    class="relative inline-flex h-8 w-14 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
                    :class="isAnnual ? 'bg-blue-600' : 'bg-slate-300 dark:bg-slate-700'"
                >
                    <span 
                        class="inline-block h-6 w-6 transform rounded-full bg-white transition-transform"
                        :class="isAnnual ? (lang==='ar' ? '-translate-x-7' : 'translate-x-7') : (lang==='ar' ? '-translate-x-1' : 'translate-x-1')"
                    ></span>
                </button>
                <span class="text-sm font-semibold" :class="isAnnual ? 'text-slate-900 dark:text-white' : 'text-slate-500'">
                    <span x-text="t('billing_annual')"></span> <span class="text-green-500 text-xs ml-1" x-text="t('save_20')"></span>
                </span>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-2xl mx-auto mb-8">
                <!-- Pro Plan -->
                <div class="relative flex flex-col rounded-xl p-6 shadow-lg bg-white dark:bg-slate-800 border-2 border-yellow-500 ring-4 ring-yellow-500/20 transform hover:-translate-y-1 transition">
                    <div class="absolute -top-3 left-1/2 transform -translate-x-1/2 bg-gradient-to-r from-yellow-500 to-amber-600 text-white px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide shadow-md" x-text="t('most_popular')">
                    </div>
                    <div class="mb-4">
                        <h3 class="text-xl font-bold flex items-center gap-2">
                            <span x-text="t('plan_pro')"></span>
                            <span class="bg-yellow-100 text-yellow-800 text-[10px] px-2 py-0.5 rounded-full border border-yellow-200">Gold</span>
                        </h3>
                        <div class="text-3xl font-bold mt-2">
                            <span x-text="getPlanPrice('pro', isAnnual ? 'annual_monthly' : 'monthly')"></span>
                            <span class="text-sm font-normal text-gray-500" x-text="t('per_month')"></span>
                        </div>
                        <p class="text-xs text-green-500 mt-1 font-semibold" x-show="isAnnual" x-text="t('billed_yearly') + ' ' + getPlanPrice('pro', 'annual_total')"></p>
                    </div>
                    <ul class="space-y-2 mb-6 text-sm">
                        <li class="flex items-center"><span class="text-green-500 mr-2">‚úì</span> <span x-text="t('feature_unlimited')"></span></li>
                        <li class="flex items-center"><span class="text-green-500 mr-2">‚úì</span> <span x-text="t('feature_no_watermark')"></span></li>
                        <li class="flex items-center"><span class="text-green-500 mr-2">‚úì</span> <span x-text="t('feature_base_gen')"></span></li>
                        <li class="flex items-center"><span class="text-green-500 mr-2">‚úì</span> <span x-text="t('feature_adv_shapes')"></span></li>
                        <li class="flex items-center"><span class="text-green-500 mr-2">‚úì</span> <span x-text="t('feature_smart_nest')"></span></li>
                    </ul>
                    <button @click="buyPlan('pro', isAnnual ? 'annual' : 'monthly')" class="mt-auto w-full py-2 bg-gradient-to-r from-yellow-500 to-amber-600 text-white font-bold rounded-lg hover:from-yellow-600 hover:to-amber-700 transition shadow-lg" x-text="t('upgrade_to_pro')"></button>
                </div>

                <!-- Business Plan -->
                <div class="relative flex flex-col rounded-xl p-6 shadow-lg bg-white dark:bg-slate-800 border border-gray-200 dark:border-slate-700 transform hover:-translate-y-1 transition">
                    <div class="mb-4">
                        <h3 class="text-xl font-bold" x-text="t('plan_business')"></h3>
                        <div class="text-3xl font-bold mt-2">
                            <span x-text="getPlanPrice('business', isAnnual ? 'annual_monthly' : 'monthly')"></span>
                            <span class="text-sm font-normal text-gray-500" x-text="t('per_month')"></span>
                        </div>
                        <p class="text-xs text-green-500 mt-1 font-semibold" x-show="isAnnual" x-text="t('billed_yearly') + ' ' + getPlanPrice('business', 'annual_total')"></p>
                    </div>
                    <ul class="space-y-2 mb-6 text-sm">
                        <li class="flex items-center"><span class="text-green-500 mr-2">‚úì</span> <span x-text="t('feature_everything_pro')"></span></li>
                        <li class="flex items-center"><span class="text-green-500 mr-2">‚úì</span> <span x-text="t('feature_commercial')"></span></li>
                        <li class="flex items-center"><span class="text-green-500 mr-2">‚úì</span> <span x-text="t('feature_priority')"></span></li>
                        <li class="flex items-center"><span class="text-green-500 mr-2">‚úì</span> <span x-text="t('feature_bulk')"></span></li>
                    </ul>
                    <button @click="buyPlan('business', isAnnual ? 'annual' : 'monthly')" class="mt-auto w-full py-2 bg-slate-100 dark:bg-slate-700 text-gray-900 dark:text-white font-bold rounded-lg hover:bg-slate-200 dark:hover:bg-slate-600 transition" x-text="t('upgrade_to_business')"></button>
                </div>
            </div>

            <div class="mt-8 pt-8 border-t dark:border-slate-700">
                <h3 class="text-xl font-bold text-center mb-6" x-text="t('pay_as_you_go')"></h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                     <button @click="buyCredits(10, 3)" class="p-4 border rounded-lg hover:border-blue-500 transition text-center">
                        <div class="font-bold text-lg" x-text="'10 ' + t('exports_count')"></div>
                        <div class="text-blue-500" x-text="formatPrice(3)"></div>
                     </button>
                     <button @click="buyCredits(50, 9)" class="p-4 border rounded-lg hover:border-blue-500 transition text-center">
                        <div class="font-bold text-lg" x-text="'50 ' + t('exports_count')"></div>
                        <div class="text-blue-500" x-text="formatPrice(9)"></div>
                     </button>
                     <button @click="buyCredits(200, 25)" class="p-4 border rounded-lg hover:border-blue-500 transition text-center">
                        <div class="font-bold text-lg" x-text="'200 ' + t('exports_count')"></div>
                        <div class="text-blue-500" x-text="formatPrice(25)"></div>
                     </button>
                </div>
            </div>
        </div>
    </div>
    <!-- About / Landing Modal (For SEO & Content) -->
    <div x-show="showAboutModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm" x-cloak x-transition>
        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-full max-w-3xl p-8 relative max-h-[90vh] overflow-y-auto" @click.outside="showAboutModal = false">
            <button @click="showAboutModal = false" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">‚úï</button>
            
            <div class="prose dark:prose-invert max-w-none">
                <h1 class="text-3xl font-bold mb-4 text-blue-600 dark:text-blue-400">Acrylic Designer Pro</h1>
                <p class="text-lg mb-6 text-gray-600 dark:text-gray-300">The ultimate professional tool for designing, nesting, and calculating costs for acrylic sheets, laser cutting, and CNC projects.</p>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div class="bg-blue-50 dark:bg-slate-700/50 p-4 rounded-lg">
                        <h3 class="font-bold text-lg mb-2">üöÄ Smart Nesting</h3>
                        <p class="text-sm">Optimize your material usage with our advanced nesting algorithm. Reduce waste and save money on every sheet.</p>
                    </div>
                    <div class="bg-green-50 dark:bg-slate-700/50 p-4 rounded-lg">
                        <h3 class="font-bold text-lg mb-2">üí∞ Instant Cost Calculation</h3>
                        <p class="text-sm">Get real-time pricing based on material area, cutting time, and profit margins. Perfect for quoting clients instantly.</p>
                    </div>
                    <div class="bg-purple-50 dark:bg-slate-700/50 p-4 rounded-lg">
                        <h3 class="font-bold text-lg mb-2">üìê Precision Design</h3>
                        <p class="text-sm">Create complex shapes with exact dimensions. Add holes, rounded corners, and custom patterns with ease.</p>
                    </div>
                    <div class="bg-orange-50 dark:bg-slate-700/50 p-4 rounded-lg">
                        <h3 class="font-bold text-lg mb-2">üìÇ Export Ready</h3>
                        <p class="text-sm">Download production-ready DXF and SVG files directly to your laser cutter or CNC machine.</p>
                    </div>
                </div>

                <h2 class="text-2xl font-bold mb-4">How to Use</h2>
                <ol class="list-decimal pl-5 space-y-2 mb-8">
                    <li><strong>Add Shapes:</strong> Use the sidebar to add rectangles, circles, or polygons.</li>
                    <li><strong>Customize:</strong> Adjust dimensions, add holes, or round corners using the properties panel.</li>
                    <li><strong>Nest:</strong> Open the "Nesting" panel to automatically arrange shapes to fit your sheet size.</li>
                    <li><strong>Calculate:</strong> Set your material cost and profit margin to see the final price.</li>
                    <li><strong>Export:</strong> Click "Export DXF" to get your file ready for cutting.</li>
                </ol>

                <p class="text-sm text-gray-500 mt-8 border-t pt-4">
                    ¬© 2026 Acrylic Designer Pro. All rights reserved. 
                    <a href="privacy.html" class="underline">Privacy Policy</a> | <a href="terms.html" class="underline">Terms of Service</a>
                </p>
            </div>
        </div>
    </div>

    <!-- PayPal Modal -->
    <div x-show="showPayPalModal" class="fixed inset-0 z-[70] flex items-center justify-center bg-black/50 backdrop-blur-sm" x-cloak x-transition>
        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-full max-w-md p-6 relative" @click.outside="showPayPalModal = false">
            <button @click="showPayPalModal = false" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">‚úï</button>
            <h2 class="text-2xl font-bold mb-4 text-center">Complete Payment</h2>
            <div class="mb-4 text-center">
                <p class="text-gray-500">Total Amount</p>
                <p class="text-3xl font-bold text-blue-600" x-text="'$' + (payPalAmount || 0)"></p>
                <p class="text-sm text-gray-400 mt-1" x-text="payPalDescription"></p>
            </div>
            <div id="paypal-button-container" class="mt-4"></div>
        </div>
    </div>

    <!-- Cookie Consent -->
    <div x-data="{ showCookie: !localStorage.getItem('cookieConsent') }" x-show="showCookie" class="fixed bottom-0 left-0 right-0 bg-gray-900 text-white p-4 z-[100] flex flex-col sm:flex-row items-center justify-between gap-4 shadow-lg" x-transition x-cloak>
        <div class="text-sm">
            We use cookies to enhance your experience and serve personalized ads. By using our site, you agree to our <a href="privacy.html" class="underline text-blue-300">Privacy Policy</a>.
        </div>
        <div class="flex gap-2">
            <button @click="showCookie = false; localStorage.setItem('cookieConsent', 'true')" class="bg-blue-600 px-4 py-2 rounded text-sm font-bold hover:bg-blue-700">Accept</button>
        </div>
    </div>
</body>
</html>
